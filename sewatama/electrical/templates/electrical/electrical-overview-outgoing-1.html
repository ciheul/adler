{% extends "base.html" %}

{% block content %}
<div class="my-container">
  {% include "sidenav-inc.html" %}
  <div id="content">
    <div class="row">
      <div class="col-md-9"><h3>Electrical <span id="notif-log"></span></h3></div>
      <div class="col-md-3">
        <div class="alert page-notif" style="display:none;">
          <div id="notif-status">
              <span id="notif-status-icon"><span class="glyphicon glyphicon-ok">&nbsp;</span></span>
            <span id="notif-content">LAST UPDATE: RECENTLY</span>
            <a id="notif-closer">Ã—</a>
          </div>
        </div>
      </div>
    </div>

    <ul class="nav nav-tabs">
      <li class="active"><a href="#"><b>Overview Outgoing #1</b></a></li>
      <li><a href="{% url 'electrical-sld-outgoing-1' %}">SLD Outgoing #1</a></li>
    </ul>

    <br>
    
    <div id="grid-0" class="gridster">
      <ul></ul>
    </div>

    <div id="grid-1" class="gridster">
      <ul></ul>
    </div>


    <div id="grid-2" class="gridster">
      <ul></ul>
    </div>
  </div>

  <script type="text/template" id="gauge-template">
    <li data-row="<%= grid.y %>" data-col="<%= grid.x %>" data-sizex="<%= grid.w %>" data-sizey="<%= grid.h %>">
      <table class="table">
        <tr><td class="widget-head"><b><%= title %></b></td></tr>
        <tr><td colspan="2"><div id="<%= tagId %>" style="margin-top:-20px;width:170px;height:170px"></div></td></tr>
      </table>
    </li>
  </script>

  <script type="text/template" id="onecolumn-table-template">
    <li data-row="<%= grid.y %>" data-col="<%= grid.x %>" data-sizex="<%= grid.w %>" data-sizey="<%= grid.h %>">
      <table class="table">
        <% if (typeof title !== 'undefined') { %>
        <thead>
          <tr><td class="widget-head"><%= title %></td></tr>
        </thead>
        <% } %>
        <tbody id="<%= tagId %>" style="font-size:12px"></tbody>
      </table>
    </li>
  </script>

  <script type="text/template" id="onecolumn-table-item-template">
    <% if (type === 'default') { %>
      <tr>
        <td>
          <div><%= name %></div>
          <div><%= value %> <%= label %></div>
        </td>
      </tr>
    <% } else if (type === 'general') { %>
      <tr>
        <td>
          <div class="btn-group">
            <% if (typeof run !== 'undefined' && run > 0) { %>
              <button class="btn btn-xs btn-success" style="font-size:10px">Run</button>
            <% } else if (typeof run !== 'undefined' && run === false) { %>
              <button class="btn btn-xs btn-danger" style="font-size:10px">Stop</button>
            <% } else { %>
              <button class="btn btn-xs" style="font-size:10px">#NA</button>
            <% } %>
            <button class="btn btn-xs" style="font-size:10px">#NA</button>
          </div>
        </td>
      </tr>
    <% } %>
  </script>

  <script type="text/template" id="threecolumns-table-template">
    <li data-row="<%= grid.y %>" data-col="<%= grid.x %>" data-sizex="<%= grid.w %>" data-sizey="<%= grid.h %>">
      <table class="table">
        <% if (typeof title !== 'undefined') { %>
          <thead>
            <tr><td class="widget-head" colspan="3"><b><%= title %></b></td></tr>
          </thead>
        <% } %>
        <tbody id="<%= tagId %>"></tbody>
      </table>
    </li>
  </script>

  <script type="text/template" id="threecolumns-table-item-template">
    <tr>
      <td style="text-align:left;padding-left:30px"><%= name %></td>
      <td style="text-align:right"><%= value %></td>
      <td style="text-align:left;width:15%"><%= label %></td>
    </tr>
  </script>
{% endblock %}

{% block javascript %}
<script type="text/javascript" id="code">
  var app = app || {};

  var gridster = [];

  app.Widget = Backbone.Model.extend({});
  app.WidgetList = Backbone.Collection.extend({
    model: app.Widget,
    url: '/electrical/api/overview-outgoing-1/'
  });

  app.DashboardView = Backbone.View.extend({
    initialize: function() {
      app.widgets = new app.WidgetList();
      app.widgets.fetch({ async: false });

      this.render();
    },

    render: function() {
      app.widgets.each(function(widget) {
        if (widget.get('type') === 'gauge') {
          var widgetView = new app.GaugeView({ model: widget });
          $('#grid-0 > ul').append(widgetView.render().el.firstElementChild);
          widgetView.bindGauge(widget.toJSON());
        }

        if (widget.get('type') === 'threeColumnsTable') {
          console.log(widget);
          var widgetView = new app.ThreeColumnsTableView({
            el: $('#grid-1 > ul'),
            model: widget.toJSON()
          });
          widgetView.render();
        }

        if (widget.get('type') === 'oneColumnTable') {
          var widgetView = new app.OneColumnTableView({
            el: $('#grid-2 > ul'),
            model: widget.toJSON()
          });
          widgetView.render();
        }
      });
    }
  });

  app.GaugeView = Backbone.View.extend({
    template: _.template($('#gauge-template').html()),
    render: function() {
      this.$el.html(this.template(this.model.toJSON()));
      return this;
    },

    bindGauge: function(params) {
      new JustGage({
        id: params.tagId,
        min: params.minValue,
        max: params.maxValue,
        value : Math.round(params.value * 100) / 100,
        label: params.label,
        decimals: 2,
        gaugeWidthScale: 0.5,
        counter: true,
        formatNumber: true
      });
    }
  });

  app.OneColumnTableView = Backbone.View.extend({
    template: _.template($('#onecolumn-table-template').html()),

    render: function() {
      // title that has two words will be rendered in two lines
      if (typeof this.model.title !== 'undefined') {
        this.model.title = this.model.title.replace(' ', '<br/>');
      }

      // render template
      this.$el.append(this.template(this.model));

      // render rows inside tbody
      var that = this;
      this.model.data.forEach(function(item) {
        var itemView = new app.OneColumnTableItemView({
          el: $('#' + that.model.tagId),
          model: item
        }); 
        itemView.render();
      });
    }
  });

  app.OneColumnTableItemView = Backbone.View.extend({
    template: _.template($('#onecolumn-table-item-template').html()),

    render: function() {
      this.$el.append(this.template(this.model));
    }
  });

  app.ThreeColumnsTableView = Backbone.View.extend({
    template: _.template($('#threecolumns-table-template').html()),

    render: function() {
      // render template
      this.$el.append(this.template(this.model));

      // render rows inside tbody
      var that = this;
      this.model.data.forEach(function(item) {
        var itemView = new app.ThreeColumnsTableItemView({
          el: $('#' + that.model.tagId),
          model: item
        }); 
        itemView.render();
      });
    }
  });

  app.ThreeColumnsTableItemView = Backbone.View.extend({
    template: _.template($('#threecolumns-table-item-template').html()),

    render: function() {
      this.$el.append(this.template(this.model));
    }
  });

  app.dashboardView = new app.DashboardView();

  gridster[0] = $("#grid-0 ul")
    .gridster({
      namespace: '#grid-0',
      widget_margins: [5, 5],
      widget_base_dimensions: [90, 20],
      min_cols: 12,
      max_cols: 12,
      max_size_x: 12})
    .data('gridster')
    .disable();

  gridster[1] = $("#grid-1 ul")
    .gridster({
      namespace: '#grid-1',
      widget_margins: [5, 5],
      widget_base_dimensions: [90, 20],
      min_cols: 12,
      max_cols: 12,
      max_size_x: 12})
    .data('gridster')
    .disable();

  gridster[2] = $("#grid-2 ul")
    .gridster({
      namespace: '#grid-2',
      widget_margins: [5, 5],
      widget_base_dimensions: [90, 16],
      min_cols: 12,
      max_cols: 12,
      max_size_x: 12})
    .data('gridster')
    .disable();

</script>
{% endblock %}
