{% extends "base.html" %}

{% block css %}
<!--link rel="stylesheet" href="/static/water/backboneapp/bower_components/gridster.js/dist/jquery.gridster.min.css" /-->
<style>

</style>
{% endblock %}

{% block content %}
<div class="my-container">
  {% include 'sidenav-inc.html' %}
  <div id="content">
    <h3>Tags</h3>

<!--form id="new-tweet">
    <input id="author-name" name="author-name" type="text">
    <input id="author-text" name="author-text" type="text">
    <input type="submit">
</form-->
<button id="" type="submit" class="btn btn-primary"><span class="glyphicon glyphicon-floppy-disk">&nbsp;</span>Save Changes</button>

<hr>
<script src="https://code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js" type="text/javascript"></script>
<div id="tweets-container"></div>
<script type="text/javascript">
(function($){
  var Tweet = Backbone.Model.extend({
    defaults: function() {
      return {
        tagname: "PUMP FAULT",
        tagvalue: "GLM\\SWRO_001\\RT01\\PUMP_FEED03\\FAULT"
      }
    }
  });
  
  var TweetList = Backbone.Collection.extend({
    model: Tweet
  });
    
  var deploy = new TweetList();
  
  for (var i=0; i<22; i++){
    deploy.add(new Tweet()); 
  }

  var TweetView = Backbone.View.extend({
    model: new Tweet(),
    tagName: 'div',
    events: {
      'click .edit': 'edit',
      'click .delete': 'delete',
      'blur .status': 'close',
      'keypress .status': 'onEnterUpdate'
    },
    initialize: function() {
      this.template = _.template($('#tweet-template').html());
    },
    edit: function(ev) {
      ev.preventDefault();
      this.$('.status').attr('contenteditable', true).focus();
    },
    close: function(ev) {
      var status = this.$('.status').text();
      this.model.set('status', status);
      this.$('.status').removeAttr('contenteditable');
    },
    onEnterUpdate: function(ev) {
      var self = this;
      if (ev.keyCode === 13) {
        this.close();
        _.delay(function() { self.$('.status').blur() }, 100);
      }
    },
    delete: function(ev) {
      ev.preventDefault();
      deploy.remove(this.model);
    },
    render: function() {
      this.$el.html(this.template(this.model.toJSON()));
      return this;
    }
  });
        
  var TweetsView = Backbone.View.extend({
    model: deploy,
    el: $('#tweets-container'),
    initialize: function() {
      this.render();
      this.model.on('add', this.render, this);
      this.model.on('remove', this.render, this);
    },
    render: function() {
      var self = this;
      self.$el.html('');
      _.each(this.model.toArray(), function(tweet, i) { 
        self.$el.append((new TweetView({model: tweet})).render().$el);
      });
      return this;
    }
  });
            
  $(document).ready(function(){
    $('#new-tweet').submit(function(ev) {
      var tweet = new Tweet({tagname: $('#author-name').val(), tagvalue: $('#author-text').val()});
      deploy.add(tweet);
      console.log(deploy.toJSON());
      return false;
    });
                        
    var appView = new TweetsView();
  });
})(jQuery);
</script>

<script type="text/template" id="tweet-template">
<div class="row">
  <div class="col-md-2">
    <label class="author"><%= tagname %></label>
  </div>
  <div class="col-md-8">
    <input class="form-control status" value="<%= tagvalue %>">
  </div>
  <div class="col-md-2" align="">
    <button href="#" class="btn btn-warning edit">edit</button>
  </div>
</div>
<div class="">&nbsp;</div>
</script>

  </div>
</div>

<div class="row">
    <div id="spin"></div>
</div>

{% endblock %}

{% block javascript %}
<script>
  $(window).on('load', function() {
    $('#spin').spin({
      color: '#000'
    });
    $('#spin').show();
    console.log('something');
  }).load(function(){
    $('#spin').hide();
    console.log('is hidden');
  });
</script>

{% endblock %}
